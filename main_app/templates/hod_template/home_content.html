{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}
{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3 class="text-mode">{{total_students}}</h3>

                        <p class="text-mode">Total Students</p>
                    </div>
                    <div class="icon">
                      <i class="nav-icon fas fa-user-graduate"></i>
                    </div>
                    <a href="{% url 'manage_student' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>

                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3 class="text-mode">{{total_staff}}</h3>

                        <p class="text-mode">Total Staff</p>
                    </div>
                    <div class="icon">
                      <i class="nav-icon fas fa-users"></i>
                    </div>
                    <a href="{% url 'manage_staff' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-purple">
                    <div class="inner">
                        <h3 class="text-mode">{{total_course}}</h3>

                        <p class="text-mode">Total Course</p>
                    </div>
                    <div class="icon">
                      <i class="nav-icon fas fa-th-list"></i>
                    </div>
                    <a href="{% url 'manage_course' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3 class="text-mode">{{total_subject}}</h3>

                        <p class="text-mode">Total Subjects</p>
                    </div>
                    <div class="icon">
                      <i class="nav-icon fas fa-book"></i>
                    </div>
                    <a href="{% url 'manage_subject' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
        </div>
        <!-- /.row -->
        <!-- Main row -->
        <div class="row">
            <div class="col-md-6">
                <!-- LINE CHART -->
                <div class="card card-dark">
                  <div class="card-header">
                    <h3 class="card-title text-white">Staffs - Students Overview</h3>
    
                    <div class="card-tools">
                      <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                      </button>
                      <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="chart">
                      <canvas id="pieChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                  </div></div>
                  <!-- /.card-body -->
                </div>
                <div class="col-md-6">
                    <div class="card card-dark">
              <div class="card-header">
                <h3 class="card-title text-white">Attendance Per Subject</h3>

                <div class="card-tools">
                  <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                  </button>
                  <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                </div>
              </div>
              <div class="card-body">
                <div class="chart">
                  <canvas id="barChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
                </div>
            <!-- right col -->
        </div>
        <!-- /.row (main row) -->
        <div class="row">
          <div class="col-lg-12">
            <!-- BAR CHART -->
            <div class="card">
              <div class="card-header bg-dark">
                <h3 class="card-title text-white">Student's Attendance & Leave Overview</h3>
                <div class="card-tools">
                  <button type="button" class="btn btn-tool text-white" data-card-widget="collapse">
                    <i class="fas fa-minus"></i>
                  </button>
                  <button type="button" class="btn btn-tool text-white" data-card-widget="remove">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="chart">
                  <canvas id="barChart2" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            
          </div>
        
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-dark">
                        <h3 class="card-title text-white">Total Students in Each Course</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool text-white" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool text-white" data-card-widget="remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="courseChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-dark">
                        <h3 class="card-title text-white">Total Students in Each Subject</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool text-white" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool text-white" data-card-widget="remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="subjectChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>


{% endblock content %}

{% block custom_js %}
<script>
    $(document).ready(function(){
        // Function to get CSS variables
        function getCssVar(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }
        
        // Get theme colors
        const textColor = getCssVar('--chart-text');
        const gridColor = getCssVar('--border-color');
        const cardBg = getCssVar('--card-bg');
        
        // Configure global Chart.js defaults
        Chart.defaults.global.defaultFontColor = textColor;
        
        // Common chart options for responsive, theme-aware design
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    fontColor: textColor
                }
            },
            tooltips: {
                backgroundColor: cardBg,
                titleFontColor: textColor,
                bodyFontColor: textColor,
                borderColor: gridColor,
                borderWidth: 1
            }
        };
        
        // Scale options for bar charts
        const scaleOptions = {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontColor: textColor
                    },
                    gridLines: {
                        color: gridColor,
                        zeroLineColor: gridColor
                    }
                }],
                xAxes: [{
                    ticks: {
                        fontColor: textColor
                    },
                    gridLines: {
                        color: gridColor,
                        zeroLineColor: gridColor
                    }
                }]
            }
        };
        
        // 1. Staff-Students Overview Chart
        var staffStudentData = {
            labels: ['Students', 'Staff'],
            datasets: [{
                data: [{{total_students}}, {{total_staff}}],
                backgroundColor: ['#4e73df', '#1cc88a'],
                hoverBackgroundColor: ['#2e59d9', '#17a673'],
                hoverBorderColor: gridColor
            }]
        };
    
        var overviewCtx = document.getElementById('pieChart').getContext('2d');
        var pieOptions = {
            ...commonOptions,
            cutoutPercentage: 80
        };
        
        new Chart(overviewCtx, {
            type: 'doughnut',
            data: staffStudentData,
            options: pieOptions
        });
    
        // 2. Attendance Per Subject Chart
        var attendanceData = {
            labels: {{ subject_list|safe }},
            datasets: [{
                label: 'Attendance Count',
                data: {{ attendance_list }},
                backgroundColor: '#36b9cc',
                borderColor: '#36b9cc',
                borderWidth: 1
            }]
        };
    
        var attendanceCtx = document.getElementById('barChart').getContext('2d');
        new Chart(attendanceCtx, {
            type: 'bar',
            data: attendanceData,
            options: {
                ...commonOptions,
                ...scaleOptions
            }
        });
    
        // 3. Student's Attendance & Leave Overview
        var studentAttendanceData = {
            labels: {{ student_name_list|safe }},
            datasets: [{
                label: 'Present',
                backgroundColor: '#1cc88a',
                data: {{ student_attendance_present_list }}
            }, {
                label: 'Absent/Leave',
                backgroundColor: '#e74a3b',
                data: {{ student_attendance_leave_list }}
            }]
        };
    
        var studentAttendanceCtx = document.getElementById('barChart2').getContext('2d');
        new Chart(studentAttendanceCtx, {
            type: 'bar',
            data: studentAttendanceData,
            options: {
                ...commonOptions,
                ...scaleOptions
            }
        });
    
        // 4. Course Statistics
        var courseData = {
            labels: {{ course_name_list|safe }},
            datasets: [{
                label: 'Number of Students',
                data: {{ student_count_list_in_course }},
                backgroundColor: '#4e73df',
                borderColor: '#4e73df',
                borderWidth: 1
            }]
        };
    
        var courseCtx = document.getElementById('courseChart').getContext('2d');
        new Chart(courseCtx, {
            type: 'bar',
            data: courseData,
            options: {
                ...commonOptions,
                ...scaleOptions
            }
        });
    
        // 5. Subject Statistics
        var subjectData = {
            labels: {{ subject_list|safe }},
            datasets: [{
                label: 'Number of Students',
                data: {{ student_count_list_in_subject }},
                backgroundColor: '#1cc88a',
                borderColor: '#1cc88a',
                borderWidth: 1
            }]
        };
    
        var subjectCtx = document.getElementById('subjectChart').getContext('2d');
        new Chart(subjectCtx, {
            type: 'bar',
            data: subjectData,
            options: {
                ...commonOptions,
                ...scaleOptions
            }
        });
        
        // Update charts when theme changes
        function updateCharts() {
            const newTextColor = getCssVar('--chart-text');
            const newGridColor = getCssVar('--border-color');
            const newCardBg = getCssVar('--card-bg');
            
            // Update all Chart instances
            Chart.helpers.each(Chart.instances, function(chart) {
                // Update legend colors
                if (chart.options.legend && chart.options.legend.labels) {
                    chart.options.legend.labels.fontColor = newTextColor;
                }
                
                // Update tooltip colors
                if (chart.options.tooltips) {
                    chart.options.tooltips.backgroundColor = newCardBg;
                    chart.options.tooltips.titleFontColor = newTextColor;
                    chart.options.tooltips.bodyFontColor = newTextColor;
                    chart.options.tooltips.borderColor = newGridColor;
                }
                
                // Update scales if they exist
                if (chart.options.scales) {
                    if (chart.options.scales.yAxes) {
                        chart.options.scales.yAxes.forEach(function(axis) {
                            if (axis.ticks) axis.ticks.fontColor = newTextColor;
                            if (axis.gridLines) {
                                axis.gridLines.color = newGridColor;
                                axis.gridLines.zeroLineColor = newGridColor;
                            }
                        });
                    }
                    
                    if (chart.options.scales.xAxes) {
                        chart.options.scales.xAxes.forEach(function(axis) {
                            if (axis.ticks) axis.ticks.fontColor = newTextColor;
                            if (axis.gridLines) {
                                axis.gridLines.color = newGridColor;
                                axis.gridLines.zeroLineColor = newGridColor;
                            }
                        });
                    }
                }
                
                // Update the chart
                chart.update();
            });
        }
        
        // Listen for theme toggle click
        $('#themeToggle').on('click', function() {
            setTimeout(updateCharts, 100); // Delay to ensure CSS has updated
        });
    });
</script>
{% endblock custom_js %}